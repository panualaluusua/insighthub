---
description: 
globs: 
alwaysApply: false
---
# Frontend Testing Standards (UI Rule)

**This rule defines comprehensive testing standards for the InsightHub frontend application including unit, E2E, and accessibility testing.**

## Key Principles
- **Test pyramid approach:** Many unit tests, fewer integration tests, minimal E2E tests
- **Accessibility-first:** Every component must pass accessibility tests
- **User-centric testing:** Test behavior, not implementation details
- **Coverage requirements:** 80% minimum, 100% for critical components
- **Performance testing:** Ensure components don't cause performance regressions

### DO / DON'T Examples
```typescript
// ✅ DO: Test user behavior and accessibility
test('button is accessible and handles clicks', async () => {
  const onClick = vi.fn();
  render(Button, { props: { onClick } });
  
  const button = screen.getByRole('button');
  expect(button).toBeInTheDocument();
  expect(button).not.toHaveAttribute('aria-disabled', 'true');
  
  await fireEvent.click(button);
  expect(onClick).toHaveBeenCalled();
});

// ❌ DON'T: Test implementation details
test('button sets internal state correctly', () => {
  const component = new Button({ target: document.body });
  expect(component.$$set).toBeDefined(); // Testing internals
});
```

## Testing Stack Configuration

### Unit Testing Setup (Vitest)
```javascript
// vitest.config.js
import { defineConfig } from 'vitest/config';
import { sveltekit } from '@sveltejs/kit/vite';

export default defineConfig({
  plugins: [sveltekit()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['src/test-setup.js'],
    include: ['src/**/*.{test,spec}.{js,ts}'],
    coverage: {
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test-setup.js',
        '**/*.d.ts',
        '**/*.config.*'
      ],
      thresholds: {
        global: {
          branches: 80,
          functions: 80,
          lines: 80,
          statements: 80
        }
      }
    }
  }
});
```

### Test Setup Configuration
```javascript
// src/test-setup.js
import '@testing-library/jest-dom';
import { vi } from 'vitest';

// Mock IntersectionObserver
global.IntersectionObserver = vi.fn(() => ({
  disconnect: vi.fn(),
  observe: vi.fn(),
  unobserve: vi.fn(),
}));

// Mock ResizeObserver
global.ResizeObserver = vi.fn(() => ({
  disconnect: vi.fn(),
  observe: vi.fn(),
  unobserve: vi.fn(),
}));

// Mock matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});

// Mock scrollTo
Object.defineProperty(window, 'scrollTo', {
  writable: true,
  value: vi.fn(),
});

// Mock fetch
global.fetch = vi.fn();
```

### Playwright E2E Configuration
```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:4173',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],
  webServer: {
    command: 'npm run build && npm run preview',
    port: 4173,
  },
});
```

## Unit Testing Standards

### Component Testing Template
```typescript
// Component.test.ts
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen, fireEvent, cleanup } from '@testing-library/svelte';
import userEvent from '@testing-library/user-event';
import Component from './Component.svelte';

describe('Component', () => {
  beforeEach(() => {
    // Setup before each test
  });

  afterEach(() => {
    cleanup();
    vi.clearAllMocks();
  });

  describe('Rendering', () => {
    it('renders with default props', () => {
      render(Component);
      expect(screen.getByRole('button')).toBeInTheDocument();
    });

    it('renders with custom props', () => {
      render(Component, {
        props: {
          variant: 'primary',
          size: 'lg',
          disabled: true
        }
      });
      
      const button = screen.getByRole('button');
      expect(button).toHaveClass('bg-primary-600');
      expect(button).toBeDisabled();
    });
  });

  describe('User Interactions', () => {
    it('handles click events', async () => {
      const user = userEvent.setup();
      const onClick = vi.fn();
      
      render(Component, { props: { onClick } });
      
      await user.click(screen.getByRole('button'));
      expect(onClick).toHaveBeenCalledOnce();
    });

    it('handles keyboard navigation', async () => {
      const user = userEvent.setup();
      const onClick = vi.fn();
      
      render(Component, { props: { onClick } });
      
      const button = screen.getByRole('button');
      button.focus();
      
      await user.keyboard('{Enter}');
      expect(onClick).toHaveBeenCalledOnce();
      
      await user.keyboard(' ');
      expect(onClick).toHaveBeenCalledTimes(2);
    });
  });

  describe('Accessibility', () => {
    it('has proper ARIA attributes', () => {
      render(Component, {
        props: {
          disabled: true,
          'aria-label': 'Submit form'
        }
      });
      
      const button = screen.getByRole('button');
      expect(button).toHaveAttribute('aria-disabled', 'true');
      expect(button).toHaveAttribute('aria-label', 'Submit form');
    });

    it('supports screen readers', () => {
      render(Component, { props: { children: 'Click me' } });
      
      const button = screen.getByRole('button', { name: 'Click me' });
      expect(button).toBeInTheDocument();
    });
  });

  describe('Error States', () => {
    it('handles invalid props gracefully', () => {
      // Test with invalid prop values
      expect(() => {
        render(Component, {
          props: { variant: 'invalid' as any }
        });
      }).not.toThrow();
    });
  });
});
```

### Form Component Testing
```typescript
// Form component testing patterns
describe('LoginForm', () => {
  it('validates email format', async () => {
    const user = userEvent.setup();
    render(LoginForm);
    
    const emailInput = screen.getByLabelText(/email/i);
    const submitButton = screen.getByRole('button', { name: /sign in/i });
    
    await user.type(emailInput, 'invalid-email');
    await user.click(submitButton);
    
    expect(screen.getByText(/valid email/i)).toBeInTheDocument();
  });

  it('shows loading state during submission', async () => {
    const user = userEvent.setup();
    const onSubmit = vi.fn().mockImplementation(() => 
      new Promise(resolve => setTimeout(resolve, 100))
    );
    
    render(LoginForm, { props: { onSubmit } });
    
    await user.type(screen.getByLabelText(/email/i), 'test@example.com');
    await user.type(screen.getByLabelText(/password/i), 'password123');
    await user.click(screen.getByRole('button', { name: /sign in/i }));
    
    expect(screen.getByText(/signing in/i)).toBeInTheDocument();
    expect(screen.getByRole('button')).toBeDisabled();
  });
});
```

### Store Testing
```typescript
// Store testing patterns
describe('feedStore', () => {
  beforeEach(() => {
    // Reset store state
    feedStore.reset();
  });

  it('loads content correctly', async () => {
    const mockContent = [{ id: '1', title: 'Test' }];
    vi.mocked(fetch).mockResolvedValueOnce({
      ok: true,
      json: () => Promise.resolve({ data: mockContent })
    } as Response);

    await feedStore.loadContent();
    
    expect(get(feedStore.content)).toEqual(mockContent);
    expect(get(feedStore.loading)).toBe(false);
  });

  it('handles errors gracefully', async () => {
    vi.mocked(fetch).mockRejectedValueOnce(new Error('Network error'));

    await feedStore.loadContent();
    
    expect(get(feedStore.error)).toBe('Failed to load content');
    expect(get(feedStore.loading)).toBe(false);
  });
});
```

## End-to-End Testing Standards

### Page Testing Template
```typescript
// page.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Feature Page', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/feature');
  });

  test('displays page content correctly', async ({ page }) => {
    await expect(page.locator('h1')).toContainText('Feature Title');
    await expect(page.locator('[data-testid="content"]')).toBeVisible();
  });

  test('handles user interactions', async ({ page }) => {
    await page.click('[data-testid="action-button"]');
    await expect(page.locator('[data-testid="result"]')).toBeVisible();
  });

  test('works on mobile devices', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 });
    
    await expect(page.locator('[data-testid="mobile-menu"]')).toBeVisible();
    await page.click('[data-testid="mobile-menu-toggle"]');
    await expect(page.locator('[data-testid="navigation"]')).toBeVisible();
  });
});
```

### Authentication Flow Testing
```typescript
// auth.spec.ts
test.describe('Authentication', () => {
  test('user can sign up successfully', async ({ page }) => {
    await page.goto('/signup');
    
    await page.fill('[data-testid="email-input"]', 'test@example.com');
    await page.fill('[data-testid="password-input"]', 'SecurePass123!');
    await page.check('[data-testid="terms-checkbox"]');
    await page.click('[data-testid="signup-button"]');
    
    await expect(page.locator('[data-testid="success-message"]')).toBeVisible();
  });

  test('validates form inputs', async ({ page }) => {
    await page.goto('/signup');
    
    await page.click('[data-testid="signup-button"]');
    
    await expect(page.locator('[data-testid="email-error"]')).toContainText('Email is required');
    await expect(page.locator('[data-testid="password-error"]')).toContainText('Password is required');
  });
});
```

### Performance Testing
```typescript
// performance.spec.ts
test.describe('Performance', () => {
  test('page loads within acceptable time', async ({ page }) => {
    const startTime = Date.now();
    
    await page.goto('/');
    await page.waitForLoadState('networkidle');
    
    const loadTime = Date.now() - startTime;
    expect(loadTime).toBeLessThan(3000); // 3 seconds
  });

  test('infinite scroll performs well', async ({ page }) => {
    await page.goto('/feed');
    
    const startTime = Date.now();
    
    // Scroll to trigger loading
    await page.evaluate(() => {
      window.scrollTo(0, document.body.scrollHeight);
    });
    
    await page.waitForSelector('[data-testid="content-item"]:nth-child(20)');
    
    const scrollTime = Date.now() - startTime;
    expect(scrollTime).toBeLessThan(1000); // 1 second
  });
});
```

## Accessibility Testing Standards

### Automated Accessibility Testing
```typescript
// accessibility.spec.ts
import AxeBuilder from '@axe-core/playwright';

test.describe('Accessibility', () => {
  test('homepage is accessible', async ({ page }) => {
    await page.goto('/');
    
    const accessibilityScanResults = await new AxeBuilder({ page })
      .withTags(['wcag2a', 'wcag2aa', 'wcag21aa'])
      .analyze();
    
    expect(accessibilityScanResults.violations).toEqual([]);
  });

  test('form components are accessible', async ({ page }) => {
    await page.goto('/signup');
    
    const accessibilityScanResults = await new AxeBuilder({ page })
      .include('[data-testid="signup-form"]')
      .analyze();
    
    expect(accessibilityScanResults.violations).toEqual([]);
  });
});
```

### Keyboard Navigation Testing
```typescript
test.describe('Keyboard Navigation', () => {
  test('user can navigate with keyboard only', async ({ page }) => {
    await page.goto('/');
    
    // Tab through interactive elements
    await page.keyboard.press('Tab');
    await expect(page.locator(':focus')).toHaveAttribute('data-testid', 'skip-link');
    
    await page.keyboard.press('Tab');
    await expect(page.locator(':focus')).toHaveAttribute('data-testid', 'logo-link');
    
    await page.keyboard.press('Tab');
    await expect(page.locator(':focus')).toHaveAttribute('data-testid', 'nav-home');
  });

  test('modal traps focus correctly', async ({ page }) => {
    await page.goto('/');
    await page.click('[data-testid="open-modal"]');
    
    // Focus should be trapped within modal
    await page.keyboard.press('Tab');
    await expect(page.locator(':focus')).toHaveAttribute('data-testid', 'modal-close');
    
    await page.keyboard.press('Tab');
    await expect(page.locator(':focus')).toHaveAttribute('data-testid', 'modal-action');
    
    await page.keyboard.press('Tab');
    await expect(page.locator(':focus')).toHaveAttribute('data-testid', 'modal-close');
  });
});
```

### Screen Reader Testing
```typescript
test.describe('Screen Reader Support', () => {
  test('announcements are made correctly', async ({ page }) => {
    await page.goto('/feed');
    
    // Check for live region announcements
    await page.click('[data-testid="load-more"]');
    
    const liveRegion = page.locator('[aria-live="polite"]');
    await expect(liveRegion).toContainText('Loading more content');
    
    await page.waitForSelector('[data-testid="new-content"]');
    await expect(liveRegion).toContainText('10 new items loaded');
  });

  test('form errors are announced', async ({ page }) => {
    await page.goto('/signup');
    
    await page.click('[data-testid="signup-button"]');
    
    const errorSummary = page.locator('[role="alert"]');
    await expect(errorSummary).toBeVisible();
    await expect(errorSummary).toContainText('Please fix the following errors');
  });
});
```

## Test Data Management

### Mock Data Patterns
```typescript
// test-utils/mocks.ts
export const mockUser = {
  id: '1',
  email: 'test@example.com',
  name: 'Test User',
  avatar: 'https://example.com/avatar.jpg'
};

export const mockContent = {
  id: '1',
  title: 'Test Content',
  description: 'This is test content',
  author: mockUser,
  createdAt: '2024-01-01T00:00:00Z',
  tags: ['test', 'mock']
};

export const createMockContentList = (count: number) => 
  Array.from({ length: count }, (_, i) => ({
    ...mockContent,
    id: String(i + 1),
    title: `Test Content ${i + 1}`
  }));
```

### API Mocking
```typescript
// test-utils/api-mocks.ts
import { vi } from 'vitest';

export const mockApiResponse = <T>(data: T, delay = 0) => {
  return vi.fn().mockImplementation(() => 
    new Promise(resolve => 
      setTimeout(() => resolve({
        ok: true,
        json: () => Promise.resolve({ data })
      }), delay)
    )
  );
};

export const mockApiError = (message: string, status = 500) => {
  return vi.fn().mockRejectedValue({
    status,
    message
  });
};
```

## Coverage Requirements

### Critical Components (100% Coverage Required)
- Authentication components (LoginForm, SignUpForm, AuthProvider)
- Base components (Button, Input, Card)
- Navigation components (MainNavigation, Sidebar)
- Form validation logic
- Error boundary components

### Standard Components (80% Coverage Required)
- Content display components
- Layout components
- Utility components
- Store logic

### Coverage Exclusions
- Configuration files
- Type definitions
- Test setup files
- Third-party integrations (mocked)

## Testing Commands

### Package.json Scripts
```json
{
  "scripts": {
    "test": "vitest",
    "test:watch": "vitest --watch",
    "test:coverage": "vitest --coverage",
    "test:ui": "vitest --ui",
    "test:e2e": "playwright test",
    "test:e2e:headed": "playwright test --headed",
    "test:a11y": "playwright test tests/accessibility.spec.ts",
    "audit:a11y": "playwright test tests/accessibility.spec.ts --reporter=html",
    "test:all": "npm run test:coverage && npm run test:e2e",
    "ci:test": "npm run test:coverage -- --reporter=json --reporter=html && npm run test:e2e"
  }
}
```

---

## See also
- [svelte_component_ui.mdc](mdc:svelte_component_ui.mdc)
- [accessibility_ui.mdc](mdc:accessibility_ui.mdc)
- [performance_ui.mdc](mdc:performance_ui.mdc)

---

## Maintenance Notes
- **Update test patterns when new component types are introduced**
- **Review coverage thresholds quarterly and adjust as needed**
- **Add new accessibility test patterns as WCAG guidelines evolve**
- **Update mock data to reflect real API changes**

