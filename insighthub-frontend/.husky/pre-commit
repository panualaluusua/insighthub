#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running quality checks before commit..."

# Change to frontend directory
cd insighthub-frontend

# Run linting
echo "üìù Checking code style and linting..."
npm run lint:json > /dev/null 2>&1
LINT_EXIT_CODE=$?

if [ $LINT_EXIT_CODE -ne 0 ]; then
  echo "‚ùå Linting failed. Please fix the issues and try again."
  npm run lint
  exit 1
fi

# Run type checking
echo "üîç Checking TypeScript types..."
npm run check > /dev/null 2>&1
TYPE_EXIT_CODE=$?

if [ $TYPE_EXIT_CODE -ne 0 ]; then
  echo "‚ùå Type checking failed. Please fix the issues and try again."
  npm run check
  exit 1
fi

# Run unit tests
echo "üß™ Running unit tests..."
npm run test > /dev/null 2>&1
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo "‚ùå Unit tests failed. Please fix the failing tests and try again."
  npm run test
  exit 1
fi

# Check test coverage
echo "üìä Checking test coverage..."
npm run test:coverage > /dev/null 2>&1
COVERAGE_EXIT_CODE=$?

if [ $COVERAGE_EXIT_CODE -ne 0 ]; then
  echo "‚ùå Test coverage below threshold. Please add more tests."
  exit 1
fi

# Run security audit
echo "üîí Running security audit..."
npm audit --audit-level=high > /dev/null 2>&1
AUDIT_EXIT_CODE=$?

if [ $AUDIT_EXIT_CODE -ne 0 ]; then
  echo "‚ö†Ô∏è  Security vulnerabilities found. Please review and fix:"
  npm audit --audit-level=high
  echo "Continue with commit? (y/N)"
  read -r response
  if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
    exit 1
  fi
fi

echo "‚úÖ All quality checks passed! Proceeding with commit..." 